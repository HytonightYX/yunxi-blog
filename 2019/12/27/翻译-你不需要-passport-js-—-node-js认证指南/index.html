<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yunxi.site","root":"/blog/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="简介诸如 Google Firebase，AWS Cognito 以及 Auth0 这样的第三方认证服务越来越流行，类似于 passport.js 这样的一站式解决方案也成为了业界标准，但是一个普遍情况是，开发者们其实并不清楚完整的认证流程到底涉及那些部分。 这一系列关于 node.js 认证的文章，旨在让你搞清楚一些概念，比如 JSON Web Token (JWT)、社交账号登录 (OAuth">
<meta property="og:type" content="article">
<meta property="og:title" content="[翻译]你不需要 passport.js — node.js认证指南">
<meta property="og:url" content="http://yunxi.site/blog/2019/12/27/翻译-你不需要-passport-js-—-node-js认证指南/index.html">
<meta property="og:site_name" content="Hytonight云息">
<meta property="og:description" content="简介诸如 Google Firebase，AWS Cognito 以及 Auth0 这样的第三方认证服务越来越流行，类似于 passport.js 这样的一站式解决方案也成为了业界标准，但是一个普遍情况是，开发者们其实并不清楚完整的认证流程到底涉及那些部分。 这一系列关于 node.js 认证的文章，旨在让你搞清楚一些概念，比如 JSON Web Token (JWT)、社交账号登录 (OAuth">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4786e85559909?w=876&h=237&f=jpeg&s=35571">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f47875bce9c545?w=1680&h=800&f=jpeg&s=52198">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4788494504f1c?w=572&h=160&f=jpeg&s=19098">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4788fce870bbf?w=584&h=616&f=jpeg&s=25245">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f478a107523508?w=1127&h=191&f=jpeg&s=29633">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f478aaae779e66?w=977&h=166&f=jpeg&s=28234">
<meta property="og:updated_time" content="2020-02-13T03:47:21.519Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[翻译]你不需要 passport.js — node.js认证指南">
<meta name="twitter:description" content="简介诸如 Google Firebase，AWS Cognito 以及 Auth0 这样的第三方认证服务越来越流行，类似于 passport.js 这样的一站式解决方案也成为了业界标准，但是一个普遍情况是，开发者们其实并不清楚完整的认证流程到底涉及那些部分。 这一系列关于 node.js 认证的文章，旨在让你搞清楚一些概念，比如 JSON Web Token (JWT)、社交账号登录 (OAuth">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4786e85559909?w=876&h=237&f=jpeg&s=35571">

<link rel="canonical" href="http://yunxi.site/blog/2019/12/27/翻译-你不需要-passport-js-—-node-js认证指南/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>[翻译]你不需要 passport.js — node.js认证指南 | Hytonight云息</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?57d30e6a21aa4345d6c1d19d35e02e03";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hytonight云息</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="default">
    <link itemprop="mainEntityOfPage" href="http://yunxi.site/blog/2019/12/27/翻译-你不需要-passport-js-—-node-js认证指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Hytonight云息">
      <meta itemprop="description" content="云之息，浴乎沂，风乎舞雩，咏而归">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hytonight云息">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [翻译]你不需要 passport.js — node.js认证指南
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-27 15:23:01" itemprop="dateCreated datePublished" datetime="2019-12-27T15:23:01+08:00">2019-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-13 11:47:21" itemprop="dateModified" datetime="2020-02-13T11:47:21+08:00">2020-02-13</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/blog/2019/12/27/翻译-你不需要-passport-js-—-node-js认证指南/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/blog/2019/12/27/翻译-你不需要-passport-js-—-node-js认证指南/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>诸如 Google Firebase，AWS Cognito 以及 Auth0 这样的第三方认证服务越来越流行，类似于 passport.js 这样的一站式解决方案也成为了业界标准，但是一个普遍情况是，开发者们其实并不清楚完整的认证流程到底涉及那些部分。</p>
<p>这一系列关于 node.js 认证的文章，旨在让你搞清楚一些概念，比如 JSON Web Token (JWT)、社交账号登录 (OAuth2)、用户模仿（一个管理员无需密码便能作为特定用户登录）。</p>
<p>当然，文末也给你准备好了一个完整的 node.js 认证流程的代码库，放在GitHub上了，你可以作为你自己项目的基础来使用。</p>
<a id="more"></a>
<blockquote>
<ul>
<li>原文地址：<a href="https://softwareontheroad.com/nodejs-jwt-authentication-oauth/" target="_blank" rel="noopener">You don’t need passport.js - Guide to node.js authentication</a></li>
<li>原文作者：<a href="https://softwareontheroad.com/author/santypk-4/" target="_blank" rel="noopener">Sam Quinn</a></li>
<li>译文出自：<a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">掘金翻译计划</a></li>
<li>本文永久链接：<a href="https://github.com/xitu/gold-miner/blob/master/TODO1/nodejs-jwt-authentication-oauth.md" target="_blank" rel="noopener">https://github.com/xitu/gold-miner/blob/master/TODO1/nodejs-jwt-authentication-oauth.md</a></li>
<li>译者：<a href="https://github.com/HytonightYX" target="_blank" rel="noopener">HytonightYX</a></li>
<li>校对者：<a href="https://github.com/HZNU-Qiu" target="_blank" rel="noopener">HZNU-Qiu</a>,<a href="https://github.com/xionglong58" target="_blank" rel="noopener">xionglong58</a></li>
</ul>
</blockquote>
<h1 id="前置知识-✍️"><a href="#前置知识-✍️" class="headerlink" title="前置知识 ✍️"></a>前置知识 ✍️</h1><p>在阅读之前，你需要先了解：</p>
<ul>
<li>数据库中如何存储用户的 email 和密码，或者客户端ID和客户端密钥，或者其他的密钥对。</li>
<li>至少一种健壮且高效的加密算法。</li>
</ul>
<p>在我写下这篇文章之时，我认为 Argon2 是目前最好的加密算法，请不要用 SHA256，SHA512 或者 MD5 这类简单的加密算法了。</p>
<p>有关这点，有兴趣的话可以去看看这篇非常棒的文章 <a href="https://medium.com/@mpreziuso/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2-e25aaf41598e" target="_blank" rel="noopener">choosing a password hashing algorithm（如何选择密码哈希算法）</a>。</p>
<h2 id="写一个注册程序-🥇"><a href="#写一个注册程序-🥇" class="headerlink" title="写一个注册程序 🥇"></a>写一个注册程序 🥇</h2><p>新用户创建账户时，必须对密码进行哈希处理并将其与电子邮件和其他详细信息（比如用户配置文件、时间戳等等）一起存储在数据库中。 </p>
<p><strong>提示:你可以去之前的文章了解 node.js 的项目结构 <a href="https://softwareontheroad.com/ideal-nodejs-project-structure" target="_blank" rel="noopener">Bulletproof node.js project architecture 🛡️</a></strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> argon2 <span class="keyword">from</span> <span class="string">'argon2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  public <span class="keyword">async</span> SignUp(email, password, name): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> passwordHashed = <span class="keyword">await</span> argon2.hash(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.create(&#123;</span><br><span class="line">      password: passwordHashed,</span><br><span class="line">      email,</span><br><span class="line">      name,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 绝对不要返回用户的密码!!!!</span></span><br><span class="line">      user: &#123;</span><br><span class="line">        email: userRecord.email,</span><br><span class="line">        name: userRecord.name,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库中，这名用户的记录看起来就是这样：</p>
<p> <img src="https://user-gold-cdn.xitu.io/2019/12/27/16f4786e85559909?w=876&amp;h=237&amp;f=jpeg&amp;s=35571" alt="User record - Database MongoDB"> <strong>Robo3T for MongoDB</strong></p>
<h2 id="再来写一个登录程序-🥈"><a href="#再来写一个登录程序-🥈" class="headerlink" title="再来写一个登录程序 🥈"></a>再来写一个登录程序 🥈</h2><p> <img src="https://user-gold-cdn.xitu.io/2019/12/27/16f47875bce9c545?w=1680&amp;h=800&amp;f=jpeg&amp;s=52198" alt="Sign-In Diagram"> </p>
<p>当一名用户想要登录时，会发生下面的事情：</p>
<p>客户端发送成对的<strong>公共标识（Public Identification）</strong>和<strong>私钥（Private key）</strong></p>
<ul>
<li><p>服务端根据发来的 email 去数据库查找用户记录。</p>
</li>
<li><p>如果找到了，服务端会将收到的密码进行哈希，然后和数据库中已经哈希过的密码进行比对。</p>
</li>
<li><p>如果这两个哈希值对上了，那么服务端就发一个 JSON Web Token (JWT)。</p>
</li>
</ul>
<p>这个 JWT 就是一个临时 key，客户端每次发器请求都需要带上这个 Token</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> argon2 <span class="keyword">from</span> <span class="string">'argon2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  public <span class="keyword">async</span> Login(email, password): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.findOne(&#123; email &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!userRecord) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'User not found'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> correctPassword = <span class="keyword">await</span> argon2.verify(userRecord.password, password);</span><br><span class="line">      <span class="keyword">if</span> (!correctPassword) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Incorrect password'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      user: &#123;</span><br><span class="line">        email: userRecord.email,</span><br><span class="line">        name: userRecord.name,</span><br><span class="line">      &#125;,</span><br><span class="line">      token: <span class="keyword">this</span>.generateJWT(userRecord),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里密码认证使用了 argon2 库来防止时序攻击（timing-based attacks），也就是说，当攻击者试图靠蛮力破解口令时需要严格遵循<a href="https://en.wikipedia.org/wiki/Timing_attack" target="_blank" rel="noopener">服务器响应时间</a>的相关准则。</p>
<p>接下来我们将讨论一下如何生成 JWT。</p>
<h1 id="但是，JWT到底是啥？-👩‍🏫"><a href="#但是，JWT到底是啥？-👩‍🏫" class="headerlink" title="但是，JWT到底是啥？ 👩‍🏫"></a>但是，JWT到底是啥？ 👩‍🏫</h1><p>一个 JSON Web Token or JWT 是一个以字符串或者 Token 形式存储的、经过编码的 JSON 对象。</p>
<p>你可以认为它是 cookie 的替代者。</p>
<p>Token 有下面三个部分（不同颜色标注）</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f4788494504f1c?w=572&amp;h=160&amp;f=jpeg&amp;s=19098" alt="JSON Web Token example"> </p>
<p>JWT 中的数据可以无需<strong>密钥（Secret）</strong>或<strong>签名（Signature)</strong>在客户端解码。</p>
<p>因此对于用户角色信息、配置文件、令牌过期时间等这些前端领域常见的信息或元数据（metadata）来说，编码在 JWT 中一起传输就变得很方便。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f4788fce870bbf?w=584&amp;h=616&amp;f=jpeg&amp;s=25245" alt></p>
<h1 id="node-js-中如何创建-JWT？-🏭"><a href="#node-js-中如何创建-JWT？-🏭" class="headerlink" title="node.js 中如何创建 JWT？ 🏭"></a>node.js 中如何创建 JWT？ 🏭</h1><p>我们实现一个 generateToken 方法来完善我们的认证服务程序吧。</p>
<p>通过使用 <code>jsonwebtoken</code> 这个库（你可以在 npmjs.com 找到它），我们就能创建一个 JWT 了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> jwt <span class="keyword">from</span> <span class="string">'jsonwebtoken'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  private generateToken(user) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data =  &#123;</span><br><span class="line">      _id: user._id,</span><br><span class="line">      name: user.name,</span><br><span class="line">      email: user.email</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> signature = <span class="string">'MySuP3R_z3kr3t'</span>;</span><br><span class="line">    <span class="keyword">const</span> expiration = <span class="string">'6h'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jwt.sign(&#123; data, &#125;, signature, &#123; <span class="attr">expiresIn</span>: expiration &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重要的是，永远不要在编码数据中包含用户的敏感信息。</p>
<p>上面 signature 变量其实就是用来生成 JWT 的密钥（secret），而且你要确保这个 signature 不会泄漏出去。</p>
<p>如果攻击者通过某种方法获取了 signature，他就能生成令牌并且伪装成用户从而窃取他们的会话（session）。</p>
<h2 id="保护端点以及验证-JWT-⚔️"><a href="#保护端点以及验证-JWT-⚔️" class="headerlink" title="保护端点以及验证 JWT ⚔️"></a>保护端点以及验证 JWT ⚔️</h2><p>现在，前端需要在每个请求中带上 JWT 才能访问到安全目标（secure endpoint）了。</p>
<p>一个比较好的做法是在请求的 header 中附带 JWT，通常是 Authorization 消息头（Authorization header）。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f478a107523508?w=1127&amp;h=191&amp;f=jpeg&amp;s=29633" alt></p>
<p>现在，我们需要在后端中创建一个 express 的中间件。</p>
<p><strong>中间件 isAuth</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> jwt <span class="keyword">from</span> <span class="string">'express-jwt'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们假定 JWT 将会在 Authorization 请求头上，但是它也可以放在 req.body 或者 query 参数中，你只要根据业务场景选个合适的就好</span></span><br><span class="line"><span class="keyword">const</span> getTokenFromHeader = <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.headers.authorization &amp;&amp; req.headers.authorization.split(<span class="string">' '</span>)[<span class="number">0</span>] === <span class="string">'Bearer'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> req.headers.authorization.split(<span class="string">' '</span>)[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> jwt(&#123;</span><br><span class="line">  secret: <span class="string">'MySuP3R_z3kr3t'</span>, <span class="comment">// 必须和上一节的代码的 signature 一样</span></span><br><span class="line"></span><br><span class="line">  userProperty: <span class="string">'token'</span>, <span class="comment">// this is where the next middleware can find the encoded data generated in services/auth:generateToken -&gt; 'req.token'</span></span><br><span class="line"></span><br><span class="line">  getToken: getTokenFromHeader, <span class="comment">// 从 request 中获取到 auth token 的方法</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>创建一个能从数据库中获取到完整用户记录的中间件，并且将这些用户信息放进 request 中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (req, res, next) =&gt; &#123;</span><br><span class="line"> <span class="keyword">const</span> decodedTokenData = req.tokenData;</span><br><span class="line"> <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.findOne(&#123; <span class="attr">_id</span>: decodedTokenData._id &#125;)</span><br><span class="line"></span><br><span class="line"> req.currentUser = userRecord;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(!userRecord) &#123;</span><br><span class="line">   <span class="keyword">return</span> res.status(<span class="number">401</span>).end(<span class="string">'User not found'</span>)</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> next();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在就可以跳转到用户请求的路由了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> isAuth <span class="keyword">from</span> <span class="string">'../middlewares/isAuth'</span>;</span><br><span class="line"><span class="keyword">import</span> attachCurrentUser <span class="keyword">from</span> <span class="string">'../middlewares/attachCurrentUser'</span>;</span><br><span class="line"><span class="keyword">import</span> ItemsModel <span class="keyword">from</span> <span class="string">'../models/items'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app) =&gt; &#123;</span><br><span class="line">  app.get(<span class="string">'/inventory/personal-items'</span>, isAuth, attachCurrentUser, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = req.currentUser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userItems = <span class="keyword">await</span> ItemsModel.find(&#123; <span class="attr">owner</span>: user._id &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(userItems).status(<span class="number">200</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过两个中间件访问到的 inventory/personal-items 路由就是安全的。你需要有效的 JWT 才能访问这个路由，当然喽，路由也需要 JWT 中的用户信息才能去数据库中正确查找相应的信息。</p>
<h2 id="为什么-JWT-是安全的"><a href="#为什么-JWT-是安全的" class="headerlink" title="为什么 JWT 是安全的 ?"></a>为什么 JWT 是安全的 ?</h2><p>你读到这里，通常会想到这么一个问题：</p>
<p>Q：如果可以在客户端中解码 JWT 数据的话，别人能否修改其中用户 id 或者其它的数据呢？</p>
<p>A：虽然你可以轻易地解码 JWT，但是没有 JWT 生成时的密钥（Secret）就无法对修改后的新数据进行编码。</p>
<p>也是因为这个原因，千万不要泄漏密钥（secret）。</p>
<p>我们的服务端会在 <code>IsAuth</code> 这个使用了 <code>express-jwt</code> 库的中间件中校验密钥。</p>
<p>现在我们已经明白了 JWT 是如何工作的，我们接下来去看一个很酷的功能。</p>
<h2 id="如何模拟一个用户-🕵️"><a href="#如何模拟一个用户-🕵️" class="headerlink" title="如何模拟一个用户 🕵️"></a>如何模拟一个用户 🕵️</h2><p>用户模拟是一种可以在无需用户密码的情况下，以一个特定用户的身份登录的技术。</p>
<p>对于超级管理员（super admins）来说，这是一个非常有用的功能，能够帮他解决或调试一个仅会话可见的用户的问题。</p>
<p>没有必要去知道用户的密码，只需要以正确的密钥和必要的用户信息来创建一个 JWT 就可以了。</p>
<p>我们来创建一个路径，来生成模拟生成特定用户登录的 JWT。这个路径只能被超级管理员账户使用。</p>
<p>首先，我们需要为超级管理员创建一个更高等级的角色，方法有很多，比较简单的一种就是直接去数据库中给用户记录添加一个“role”字段。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f478aaae779e66?w=977&amp;h=166&amp;f=jpeg&amp;s=28234" alt> </p>
<p>然后，我们创建一个新的中间件来检查用户角色。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (requiredRole) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.currentUser.role === requiredRole) &#123;</span><br><span class="line">      <span class="keyword">return</span> next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">401</span>).send(<span class="string">'Action not allowed'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个中间件需要放在 <code>isAuth</code> 和 <code>attachCurrentUser</code> 之后。</p>
<p>最后，这个路径将会生成一个能够模拟用户的 JWT 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> isAuth <span class="keyword">from</span> <span class="string">'../middlewares/isAuth'</span>;</span><br><span class="line"><span class="keyword">import</span> attachCurrentUser <span class="keyword">from</span> <span class="string">'../middlewares/attachCurrentUser'</span>;</span><br><span class="line"><span class="keyword">import</span> roleRequired <span class="keyword">from</span> <span class="string">'../middlwares/roleRequired'</span>;</span><br><span class="line"><span class="keyword">import</span> UserModel <span class="keyword">from</span> <span class="string">'../models/user'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app) =&gt; &#123;</span><br><span class="line">  app.post(<span class="string">'/auth/signin-as-user'</span>, isAuth, attachCurrentUser, roleRequired(<span class="string">'super-admin'</span>), (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEmail = req.body.email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.findOne(&#123; <span class="attr">email</span>: userEmail &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!userRecord) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'User not found'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">      user: &#123;</span><br><span class="line">        email: userRecord.email,</span><br><span class="line">        name: userRecord.name</span><br><span class="line">      &#125;,</span><br><span class="line">      jwt: <span class="keyword">this</span>.generateToken(userRecord)</span><br><span class="line">    &#125;)</span><br><span class="line">    .status(<span class="number">200</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，这里并没有什么黑魔法，超级管理员只需要知道需要被模拟的用户的Email（并且这里的逻辑与登录十分相似，只是无需检查口令的正确性）就可以模拟这个用户了。</p>
<p>当然，也正是因为不需要密码，这个路径的安全性就得靠 roleRequired 中间件来保证了。</p>
<h1 id="结论-🏗️"><a href="#结论-🏗️" class="headerlink" title="结论 🏗️"></a>结论 🏗️</h1><p>虽然依赖第三方认证服务和库很方便，节约了开发时间，但是我们也需要了解认证背后的底层逻辑和原理。</p>
<p>在这篇文章中我们探讨了 JWT 的功能，为什么选择一个好的加密算法非常重要，以及如何去模拟一个用户，如果你使用的是 passport.js 这样的库，就很难做到这些事。</p>
<p>在本系列的下一篇文章中，我们将探讨通过使用 OAuth2 协议和更简单的替代方案（如 Firebase 等第三方用于身份验证的库）来为客户提供“社交登录”身份验证的不同方法。</p>
<h3 id="这里是示例仓库-🔬"><a href="#这里是示例仓库-🔬" class="headerlink" title="这里是示例仓库 🔬"></a><a href="https://github.com/santiq/nodejs-auth" target="_blank" rel="noopener">这里是示例仓库 🔬</a></h3><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://security.stackexchange.com/questions/193351/in-2018-what-is-the-recommended-hash-to-store-passwords-bcrypt-scrypt-argon2" target="_blank" rel="noopener">What is the recommended hash to store passwords: bcrypt, scrypt, Argon2?</a></li>
<li><a href="https://en.wikipedia.org/wiki/Timing_attack" target="_blank" rel="noopener">Timing attack</a></li>
</ul>
<blockquote>
<p>如果发现译文存在错误或其他需要改进的地方，欢迎到 <a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">掘金翻译计划</a> 对译文进行修改并 PR，也可获得相应奖励积分。文章开头的 <strong>本文永久链接</strong> 即为本文在 GitHub 上的 MarkDown 链接。</p>
</blockquote>
<hr>
<blockquote>
<p><a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">掘金翻译计划</a> 是一个翻译优质互联网技术文章的社区，文章来源为 <a href="https://juejin.im" target="_blank" rel="noopener">掘金</a> 上的英文分享文章。内容覆盖 <a href="https://github.com/xitu/gold-miner#android" target="_blank" rel="noopener">Android</a>、<a href="https://github.com/xitu/gold-miner#ios" target="_blank" rel="noopener">iOS</a>、<a href="https://github.com/xitu/gold-miner#前端" target="_blank" rel="noopener">前端</a>、<a href="https://github.com/xitu/gold-miner#后端" target="_blank" rel="noopener">后端</a>、<a href="https://github.com/xitu/gold-miner#区块链" target="_blank" rel="noopener">区块链</a>、<a href="https://github.com/xitu/gold-miner#产品" target="_blank" rel="noopener">产品</a>、<a href="https://github.com/xitu/gold-miner#设计" target="_blank" rel="noopener">设计</a>、<a href="https://github.com/xitu/gold-miner#人工智能" target="_blank" rel="noopener">人工智能</a>等领域，想要查看更多优质译文请持续关注 <a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">掘金翻译计划</a>、<a href="http://weibo.com/juejinfanyi" target="_blank" rel="noopener">官方微博</a>、<a href="https://zhuanlan.zhihu.com/juejinfanyi" target="_blank" rel="noopener">知乎专栏</a>。</p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2019/10/22/校对-如何设计一款讨人喜欢的暗色主题/" rel="prev" title="校对-如何设计一款讨人喜欢的暗色主题">
      <i class="fa fa-chevron-left"></i> 校对-如何设计一款讨人喜欢的暗色主题
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2020/02/01/关于这几个月/" rel="next" title="关于这几个月">
      关于这几个月 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#前置知识-✍️"><span class="nav-text">前置知识 ✍️</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#写一个注册程序-🥇"><span class="nav-text">写一个注册程序 🥇</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#再来写一个登录程序-🥈"><span class="nav-text">再来写一个登录程序 🥈</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#但是，JWT到底是啥？-👩‍🏫"><span class="nav-text">但是，JWT到底是啥？ 👩‍🏫</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#node-js-中如何创建-JWT？-🏭"><span class="nav-text">node.js 中如何创建 JWT？ 🏭</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#保护端点以及验证-JWT-⚔️"><span class="nav-text">保护端点以及验证 JWT ⚔️</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么-JWT-是安全的"><span class="nav-text">为什么 JWT 是安全的 ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何模拟一个用户-🕵️"><span class="nav-text">如何模拟一个用户 🕵️</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结论-🏗️"><span class="nav-text">结论 🏗️</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#这里是示例仓库-🔬"><span class="nav-text">这里是示例仓库 🔬</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-text">参考资料</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Hytonight云息</p>
  <div class="site-description" itemprop="description">云之息，浴乎沂，风乎舞雩，咏而归</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/HytonightYX" title="GitHub → https://github.com/HytonightYX" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:whosiyuan@qq.com" title="E-Mail → mailto:whosiyuan@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div><a href="http://www.beian.miit.gov.cn">浙ICP备19011570号-2</a></div>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hytonight云息</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>
<script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script>
<script src="/blog/js/schemes/muse.js"></script>
<script src="/blog/js/next-boot.js"></script>



  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'poBG3RLh2xdaKYTvOB9yLgTP-gzGzoHsz',
      appKey     : 'uKHvvpz0NYgD3n5uxJKWUdVE',
      placeholder: "Lorem Ipsum...",
      avatar     : 'mp',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
