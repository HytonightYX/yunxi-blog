<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yunxi.site","root":"/blog/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="ç®€ä»‹è¯¸å¦‚ Google Firebaseï¼ŒAWS Cognito ä»¥åŠ Auth0 è¿™æ ·çš„ç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œç±»ä¼¼äº passport.js è¿™æ ·çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆä¹Ÿæˆä¸ºäº†ä¸šç•Œæ ‡å‡†ï¼Œä½†æ˜¯ä¸€ä¸ªæ™®éæƒ…å†µæ˜¯ï¼Œå¼€å‘è€…ä»¬å…¶å®å¹¶ä¸æ¸…æ¥šå®Œæ•´çš„è®¤è¯æµç¨‹åˆ°åº•æ¶‰åŠé‚£äº›éƒ¨åˆ†ã€‚ è¿™ä¸€ç³»åˆ—å…³äº node.js è®¤è¯çš„æ–‡ç« ï¼Œæ—¨åœ¨è®©ä½ ææ¸…æ¥šä¸€äº›æ¦‚å¿µï¼Œæ¯”å¦‚ JSON Web Token (JWT)ã€ç¤¾äº¤è´¦å·ç™»å½• (OAuth">
<meta property="og:type" content="article">
<meta property="og:title" content="[ç¿»è¯‘]ä½ ä¸éœ€è¦ passport.js â€” node.jsè®¤è¯æŒ‡å—">
<meta property="og:url" content="http://yunxi.site/blog/2019/12/27/ç¿»è¯‘-ä½ ä¸éœ€è¦-passport-js-â€”-node-jsè®¤è¯æŒ‡å—/index.html">
<meta property="og:site_name" content="Hytonightäº‘æ¯">
<meta property="og:description" content="ç®€ä»‹è¯¸å¦‚ Google Firebaseï¼ŒAWS Cognito ä»¥åŠ Auth0 è¿™æ ·çš„ç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œç±»ä¼¼äº passport.js è¿™æ ·çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆä¹Ÿæˆä¸ºäº†ä¸šç•Œæ ‡å‡†ï¼Œä½†æ˜¯ä¸€ä¸ªæ™®éæƒ…å†µæ˜¯ï¼Œå¼€å‘è€…ä»¬å…¶å®å¹¶ä¸æ¸…æ¥šå®Œæ•´çš„è®¤è¯æµç¨‹åˆ°åº•æ¶‰åŠé‚£äº›éƒ¨åˆ†ã€‚ è¿™ä¸€ç³»åˆ—å…³äº node.js è®¤è¯çš„æ–‡ç« ï¼Œæ—¨åœ¨è®©ä½ ææ¸…æ¥šä¸€äº›æ¦‚å¿µï¼Œæ¯”å¦‚ JSON Web Token (JWT)ã€ç¤¾äº¤è´¦å·ç™»å½• (OAuth">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4786e85559909?w=876&h=237&f=jpeg&s=35571">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f47875bce9c545?w=1680&h=800&f=jpeg&s=52198">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4788494504f1c?w=572&h=160&f=jpeg&s=19098">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4788fce870bbf?w=584&h=616&f=jpeg&s=25245">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f478a107523508?w=1127&h=191&f=jpeg&s=29633">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f478aaae779e66?w=977&h=166&f=jpeg&s=28234">
<meta property="og:updated_time" content="2020-02-13T03:47:21.519Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[ç¿»è¯‘]ä½ ä¸éœ€è¦ passport.js â€” node.jsè®¤è¯æŒ‡å—">
<meta name="twitter:description" content="ç®€ä»‹è¯¸å¦‚ Google Firebaseï¼ŒAWS Cognito ä»¥åŠ Auth0 è¿™æ ·çš„ç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œç±»ä¼¼äº passport.js è¿™æ ·çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆä¹Ÿæˆä¸ºäº†ä¸šç•Œæ ‡å‡†ï¼Œä½†æ˜¯ä¸€ä¸ªæ™®éæƒ…å†µæ˜¯ï¼Œå¼€å‘è€…ä»¬å…¶å®å¹¶ä¸æ¸…æ¥šå®Œæ•´çš„è®¤è¯æµç¨‹åˆ°åº•æ¶‰åŠé‚£äº›éƒ¨åˆ†ã€‚ è¿™ä¸€ç³»åˆ—å…³äº node.js è®¤è¯çš„æ–‡ç« ï¼Œæ—¨åœ¨è®©ä½ ææ¸…æ¥šä¸€äº›æ¦‚å¿µï¼Œæ¯”å¦‚ JSON Web Token (JWT)ã€ç¤¾äº¤è´¦å·ç™»å½• (OAuth">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2019/12/27/16f4786e85559909?w=876&h=237&f=jpeg&s=35571">

<link rel="canonical" href="http://yunxi.site/blog/2019/12/27/ç¿»è¯‘-ä½ ä¸éœ€è¦-passport-js-â€”-node-jsè®¤è¯æŒ‡å—/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>[ç¿»è¯‘]ä½ ä¸éœ€è¦ passport.js â€” node.jsè®¤è¯æŒ‡å— | Hytonightäº‘æ¯</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?57d30e6a21aa4345d6c1d19d35e02e03";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hytonightäº‘æ¯</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="default">
    <link itemprop="mainEntityOfPage" href="http://yunxi.site/blog/2019/12/27/ç¿»è¯‘-ä½ ä¸éœ€è¦-passport-js-â€”-node-jsè®¤è¯æŒ‡å—/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Hytonightäº‘æ¯">
      <meta itemprop="description" content="äº‘ä¹‹æ¯ï¼Œæµ´ä¹æ²‚ï¼Œé£ä¹èˆé›©ï¼Œå’è€Œå½’">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hytonightäº‘æ¯">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [ç¿»è¯‘]ä½ ä¸éœ€è¦ passport.js â€” node.jsè®¤è¯æŒ‡å—
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-27 15:23:01" itemprop="dateCreated datePublished" datetime="2019-12-27T15:23:01+08:00">2019-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-13 11:47:21" itemprop="dateModified" datetime="2020-02-13T11:47:21+08:00">2020-02-13</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/blog/2019/12/27/ç¿»è¯‘-ä½ ä¸éœ€è¦-passport-js-â€”-node-jsè®¤è¯æŒ‡å—/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/blog/2019/12/27/ç¿»è¯‘-ä½ ä¸éœ€è¦-passport-js-â€”-node-jsè®¤è¯æŒ‡å—/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>è¯¸å¦‚ Google Firebaseï¼ŒAWS Cognito ä»¥åŠ Auth0 è¿™æ ·çš„ç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡è¶Šæ¥è¶Šæµè¡Œï¼Œç±»ä¼¼äº passport.js è¿™æ ·çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆä¹Ÿæˆä¸ºäº†ä¸šç•Œæ ‡å‡†ï¼Œä½†æ˜¯ä¸€ä¸ªæ™®éæƒ…å†µæ˜¯ï¼Œå¼€å‘è€…ä»¬å…¶å®å¹¶ä¸æ¸…æ¥šå®Œæ•´çš„è®¤è¯æµç¨‹åˆ°åº•æ¶‰åŠé‚£äº›éƒ¨åˆ†ã€‚</p>
<p>è¿™ä¸€ç³»åˆ—å…³äº node.js è®¤è¯çš„æ–‡ç« ï¼Œæ—¨åœ¨è®©ä½ ææ¸…æ¥šä¸€äº›æ¦‚å¿µï¼Œæ¯”å¦‚ JSON Web Token (JWT)ã€ç¤¾äº¤è´¦å·ç™»å½• (OAuth2)ã€ç”¨æˆ·æ¨¡ä»¿ï¼ˆä¸€ä¸ªç®¡ç†å‘˜æ— éœ€å¯†ç ä¾¿èƒ½ä½œä¸ºç‰¹å®šç”¨æˆ·ç™»å½•ï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œæ–‡æœ«ä¹Ÿç»™ä½ å‡†å¤‡å¥½äº†ä¸€ä¸ªå®Œæ•´çš„ node.js è®¤è¯æµç¨‹çš„ä»£ç åº“ï¼Œæ”¾åœ¨GitHubä¸Šäº†ï¼Œä½ å¯ä»¥ä½œä¸ºä½ è‡ªå·±é¡¹ç›®çš„åŸºç¡€æ¥ä½¿ç”¨ã€‚</p>
<a id="more"></a>
<blockquote>
<ul>
<li>åŸæ–‡åœ°å€ï¼š<a href="https://softwareontheroad.com/nodejs-jwt-authentication-oauth/" target="_blank" rel="noopener">You donâ€™t need passport.js - Guide to node.js authentication</a></li>
<li>åŸæ–‡ä½œè€…ï¼š<a href="https://softwareontheroad.com/author/santypk-4/" target="_blank" rel="noopener">Sam Quinn</a></li>
<li>è¯‘æ–‡å‡ºè‡ªï¼š<a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">æ˜é‡‘ç¿»è¯‘è®¡åˆ’</a></li>
<li>æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š<a href="https://github.com/xitu/gold-miner/blob/master/TODO1/nodejs-jwt-authentication-oauth.md" target="_blank" rel="noopener">https://github.com/xitu/gold-miner/blob/master/TODO1/nodejs-jwt-authentication-oauth.md</a></li>
<li>è¯‘è€…ï¼š<a href="https://github.com/HytonightYX" target="_blank" rel="noopener">HytonightYX</a></li>
<li>æ ¡å¯¹è€…ï¼š<a href="https://github.com/HZNU-Qiu" target="_blank" rel="noopener">HZNU-Qiu</a>,<a href="https://github.com/xionglong58" target="_blank" rel="noopener">xionglong58</a></li>
</ul>
</blockquote>
<h1 id="å‰ç½®çŸ¥è¯†-âœï¸"><a href="#å‰ç½®çŸ¥è¯†-âœï¸" class="headerlink" title="å‰ç½®çŸ¥è¯† âœï¸"></a>å‰ç½®çŸ¥è¯† âœï¸</h1><p>åœ¨é˜…è¯»ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆäº†è§£ï¼š</p>
<ul>
<li>æ•°æ®åº“ä¸­å¦‚ä½•å­˜å‚¨ç”¨æˆ·çš„ email å’Œå¯†ç ï¼Œæˆ–è€…å®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥ï¼Œæˆ–è€…å…¶ä»–çš„å¯†é’¥å¯¹ã€‚</li>
<li>è‡³å°‘ä¸€ç§å¥å£®ä¸”é«˜æ•ˆçš„åŠ å¯†ç®—æ³•ã€‚</li>
</ul>
<p>åœ¨æˆ‘å†™ä¸‹è¿™ç¯‡æ–‡ç« ä¹‹æ—¶ï¼Œæˆ‘è®¤ä¸º Argon2 æ˜¯ç›®å‰æœ€å¥½çš„åŠ å¯†ç®—æ³•ï¼Œè¯·ä¸è¦ç”¨ SHA256ï¼ŒSHA512 æˆ–è€… MD5 è¿™ç±»ç®€å•çš„åŠ å¯†ç®—æ³•äº†ã€‚</p>
<p>æœ‰å…³è¿™ç‚¹ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥å»çœ‹çœ‹è¿™ç¯‡éå¸¸æ£’çš„æ–‡ç«  <a href="https://medium.com/@mpreziuso/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2-e25aaf41598e" target="_blank" rel="noopener">choosing a password hashing algorithmï¼ˆå¦‚ä½•é€‰æ‹©å¯†ç å“ˆå¸Œç®—æ³•ï¼‰</a>ã€‚</p>
<h2 id="å†™ä¸€ä¸ªæ³¨å†Œç¨‹åº-ğŸ¥‡"><a href="#å†™ä¸€ä¸ªæ³¨å†Œç¨‹åº-ğŸ¥‡" class="headerlink" title="å†™ä¸€ä¸ªæ³¨å†Œç¨‹åº ğŸ¥‡"></a>å†™ä¸€ä¸ªæ³¨å†Œç¨‹åº ğŸ¥‡</h2><p>æ–°ç”¨æˆ·åˆ›å»ºè´¦æˆ·æ—¶ï¼Œå¿…é¡»å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œå¤„ç†å¹¶å°†å…¶ä¸ç”µå­é‚®ä»¶å’Œå…¶ä»–è¯¦ç»†ä¿¡æ¯ï¼ˆæ¯”å¦‚ç”¨æˆ·é…ç½®æ–‡ä»¶ã€æ—¶é—´æˆ³ç­‰ç­‰ï¼‰ä¸€èµ·å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ </p>
<p><strong>æç¤º:ä½ å¯ä»¥å»ä¹‹å‰çš„æ–‡ç« äº†è§£ node.js çš„é¡¹ç›®ç»“æ„ <a href="https://softwareontheroad.com/ideal-nodejs-project-structure" target="_blank" rel="noopener">Bulletproof node.js project architecture ğŸ›¡ï¸</a></strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> argon2 <span class="keyword">from</span> <span class="string">'argon2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  public <span class="keyword">async</span> SignUp(email, password, name): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> passwordHashed = <span class="keyword">await</span> argon2.hash(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.create(&#123;</span><br><span class="line">      password: passwordHashed,</span><br><span class="line">      email,</span><br><span class="line">      name,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ç»å¯¹ä¸è¦è¿”å›ç”¨æˆ·çš„å¯†ç !!!!</span></span><br><span class="line">      user: &#123;</span><br><span class="line">        email: userRecord.email,</span><br><span class="line">        name: userRecord.name,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•°æ®åº“ä¸­ï¼Œè¿™åç”¨æˆ·çš„è®°å½•çœ‹èµ·æ¥å°±æ˜¯è¿™æ ·ï¼š</p>
<p> <img src="https://user-gold-cdn.xitu.io/2019/12/27/16f4786e85559909?w=876&amp;h=237&amp;f=jpeg&amp;s=35571" alt="User record - Database MongoDB"> <strong>Robo3T for MongoDB</strong></p>
<h2 id="å†æ¥å†™ä¸€ä¸ªç™»å½•ç¨‹åº-ğŸ¥ˆ"><a href="#å†æ¥å†™ä¸€ä¸ªç™»å½•ç¨‹åº-ğŸ¥ˆ" class="headerlink" title="å†æ¥å†™ä¸€ä¸ªç™»å½•ç¨‹åº ğŸ¥ˆ"></a>å†æ¥å†™ä¸€ä¸ªç™»å½•ç¨‹åº ğŸ¥ˆ</h2><p> <img src="https://user-gold-cdn.xitu.io/2019/12/27/16f47875bce9c545?w=1680&amp;h=800&amp;f=jpeg&amp;s=52198" alt="Sign-In Diagram"> </p>
<p>å½“ä¸€åç”¨æˆ·æƒ³è¦ç™»å½•æ—¶ï¼Œä¼šå‘ç”Ÿä¸‹é¢çš„äº‹æƒ…ï¼š</p>
<p>å®¢æˆ·ç«¯å‘é€æˆå¯¹çš„<strong>å…¬å…±æ ‡è¯†ï¼ˆPublic Identificationï¼‰</strong>å’Œ<strong>ç§é’¥ï¼ˆPrivate keyï¼‰</strong></p>
<ul>
<li><p>æœåŠ¡ç«¯æ ¹æ®å‘æ¥çš„ email å»æ•°æ®åº“æŸ¥æ‰¾ç”¨æˆ·è®°å½•ã€‚</p>
</li>
<li><p>å¦‚æœæ‰¾åˆ°äº†ï¼ŒæœåŠ¡ç«¯ä¼šå°†æ”¶åˆ°çš„å¯†ç è¿›è¡Œå“ˆå¸Œï¼Œç„¶åå’Œæ•°æ®åº“ä¸­å·²ç»å“ˆå¸Œè¿‡çš„å¯†ç è¿›è¡Œæ¯”å¯¹ã€‚</p>
</li>
<li><p>å¦‚æœè¿™ä¸¤ä¸ªå“ˆå¸Œå€¼å¯¹ä¸Šäº†ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯å°±å‘ä¸€ä¸ª JSON Web Token (JWT)ã€‚</p>
</li>
</ul>
<p>è¿™ä¸ª JWT å°±æ˜¯ä¸€ä¸ªä¸´æ—¶ keyï¼Œå®¢æˆ·ç«¯æ¯æ¬¡å‘å™¨è¯·æ±‚éƒ½éœ€è¦å¸¦ä¸Šè¿™ä¸ª Token</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> argon2 <span class="keyword">from</span> <span class="string">'argon2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  public <span class="keyword">async</span> Login(email, password): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.findOne(&#123; email &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!userRecord) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'User not found'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> correctPassword = <span class="keyword">await</span> argon2.verify(userRecord.password, password);</span><br><span class="line">      <span class="keyword">if</span> (!correctPassword) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Incorrect password'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      user: &#123;</span><br><span class="line">        email: userRecord.email,</span><br><span class="line">        name: userRecord.name,</span><br><span class="line">      &#125;,</span><br><span class="line">      token: <span class="keyword">this</span>.generateJWT(userRecord),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯†ç è®¤è¯ä½¿ç”¨äº† argon2 åº“æ¥é˜²æ­¢æ—¶åºæ”»å‡»ï¼ˆtiming-based attacksï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ”»å‡»è€…è¯•å›¾é è›®åŠ›ç ´è§£å£ä»¤æ—¶éœ€è¦ä¸¥æ ¼éµå¾ª<a href="https://en.wikipedia.org/wiki/Timing_attack" target="_blank" rel="noopener">æœåŠ¡å™¨å“åº”æ—¶é—´</a>çš„ç›¸å…³å‡†åˆ™ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†è®¨è®ºä¸€ä¸‹å¦‚ä½•ç”Ÿæˆ JWTã€‚</p>
<h1 id="ä½†æ˜¯ï¼ŒJWTåˆ°åº•æ˜¯å•¥ï¼Ÿ-ğŸ‘©â€ğŸ«"><a href="#ä½†æ˜¯ï¼ŒJWTåˆ°åº•æ˜¯å•¥ï¼Ÿ-ğŸ‘©â€ğŸ«" class="headerlink" title="ä½†æ˜¯ï¼ŒJWTåˆ°åº•æ˜¯å•¥ï¼Ÿ ğŸ‘©â€ğŸ«"></a>ä½†æ˜¯ï¼ŒJWTåˆ°åº•æ˜¯å•¥ï¼Ÿ ğŸ‘©â€ğŸ«</h1><p>ä¸€ä¸ª JSON Web Token or JWT æ˜¯ä¸€ä¸ªä»¥å­—ç¬¦ä¸²æˆ–è€… Token å½¢å¼å­˜å‚¨çš„ã€ç»è¿‡ç¼–ç çš„ JSON å¯¹è±¡ã€‚</p>
<p>ä½ å¯ä»¥è®¤ä¸ºå®ƒæ˜¯ cookie çš„æ›¿ä»£è€…ã€‚</p>
<p>Token æœ‰ä¸‹é¢ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆä¸åŒé¢œè‰²æ ‡æ³¨ï¼‰</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f4788494504f1c?w=572&amp;h=160&amp;f=jpeg&amp;s=19098" alt="JSON Web Token example"> </p>
<p>JWT ä¸­çš„æ•°æ®å¯ä»¥æ— éœ€<strong>å¯†é’¥ï¼ˆSecretï¼‰</strong>æˆ–<strong>ç­¾åï¼ˆSignature)</strong>åœ¨å®¢æˆ·ç«¯è§£ç ã€‚</p>
<p>å› æ­¤å¯¹äºç”¨æˆ·è§’è‰²ä¿¡æ¯ã€é…ç½®æ–‡ä»¶ã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ç­‰è¿™äº›å‰ç«¯é¢†åŸŸå¸¸è§çš„ä¿¡æ¯æˆ–å…ƒæ•°æ®ï¼ˆmetadataï¼‰æ¥è¯´ï¼Œç¼–ç åœ¨ JWT ä¸­ä¸€èµ·ä¼ è¾“å°±å˜å¾—å¾ˆæ–¹ä¾¿ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f4788fce870bbf?w=584&amp;h=616&amp;f=jpeg&amp;s=25245" alt></p>
<h1 id="node-js-ä¸­å¦‚ä½•åˆ›å»º-JWTï¼Ÿ-ğŸ­"><a href="#node-js-ä¸­å¦‚ä½•åˆ›å»º-JWTï¼Ÿ-ğŸ­" class="headerlink" title="node.js ä¸­å¦‚ä½•åˆ›å»º JWTï¼Ÿ ğŸ­"></a>node.js ä¸­å¦‚ä½•åˆ›å»º JWTï¼Ÿ ğŸ­</h1><p>æˆ‘ä»¬å®ç°ä¸€ä¸ª generateToken æ–¹æ³•æ¥å®Œå–„æˆ‘ä»¬çš„è®¤è¯æœåŠ¡ç¨‹åºå§ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨ <code>jsonwebtoken</code> è¿™ä¸ªåº“ï¼ˆä½ å¯ä»¥åœ¨ npmjs.com æ‰¾åˆ°å®ƒï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½åˆ›å»ºä¸€ä¸ª JWT äº†ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> jwt <span class="keyword">from</span> <span class="string">'jsonwebtoken'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  private generateToken(user) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data =  &#123;</span><br><span class="line">      _id: user._id,</span><br><span class="line">      name: user.name,</span><br><span class="line">      email: user.email</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> signature = <span class="string">'MySuP3R_z3kr3t'</span>;</span><br><span class="line">    <span class="keyword">const</span> expiration = <span class="string">'6h'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jwt.sign(&#123; data, &#125;, signature, &#123; <span class="attr">expiresIn</span>: expiration &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡è¦çš„æ˜¯ï¼Œæ°¸è¿œä¸è¦åœ¨ç¼–ç æ•°æ®ä¸­åŒ…å«ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯ã€‚</p>
<p>ä¸Šé¢ signature å˜é‡å…¶å®å°±æ˜¯ç”¨æ¥ç”Ÿæˆ JWT çš„å¯†é’¥ï¼ˆsecretï¼‰ï¼Œè€Œä¸”ä½ è¦ç¡®ä¿è¿™ä¸ª signature ä¸ä¼šæ³„æ¼å‡ºå»ã€‚</p>
<p>å¦‚æœæ”»å‡»è€…é€šè¿‡æŸç§æ–¹æ³•è·å–äº† signatureï¼Œä»–å°±èƒ½ç”Ÿæˆä»¤ç‰Œå¹¶ä¸”ä¼ªè£…æˆç”¨æˆ·ä»è€Œçªƒå–ä»–ä»¬çš„ä¼šè¯ï¼ˆsessionï¼‰ã€‚</p>
<h2 id="ä¿æŠ¤ç«¯ç‚¹ä»¥åŠéªŒè¯-JWT-âš”ï¸"><a href="#ä¿æŠ¤ç«¯ç‚¹ä»¥åŠéªŒè¯-JWT-âš”ï¸" class="headerlink" title="ä¿æŠ¤ç«¯ç‚¹ä»¥åŠéªŒè¯ JWT âš”ï¸"></a>ä¿æŠ¤ç«¯ç‚¹ä»¥åŠéªŒè¯ JWT âš”ï¸</h2><p>ç°åœ¨ï¼Œå‰ç«¯éœ€è¦åœ¨æ¯ä¸ªè¯·æ±‚ä¸­å¸¦ä¸Š JWT æ‰èƒ½è®¿é—®åˆ°å®‰å…¨ç›®æ ‡ï¼ˆsecure endpointï¼‰äº†ã€‚</p>
<p>ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•æ˜¯åœ¨è¯·æ±‚çš„ header ä¸­é™„å¸¦ JWTï¼Œé€šå¸¸æ˜¯ Authorization æ¶ˆæ¯å¤´ï¼ˆAuthorization headerï¼‰ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f478a107523508?w=1127&amp;h=191&amp;f=jpeg&amp;s=29633" alt></p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åç«¯ä¸­åˆ›å»ºä¸€ä¸ª express çš„ä¸­é—´ä»¶ã€‚</p>
<p><strong>ä¸­é—´ä»¶ isAuth</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> jwt <span class="keyword">from</span> <span class="string">'express-jwt'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å‡å®š JWT å°†ä¼šåœ¨ Authorization è¯·æ±‚å¤´ä¸Šï¼Œä½†æ˜¯å®ƒä¹Ÿå¯ä»¥æ”¾åœ¨ req.body æˆ–è€… query å‚æ•°ä¸­ï¼Œä½ åªè¦æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰ä¸ªåˆé€‚çš„å°±å¥½</span></span><br><span class="line"><span class="keyword">const</span> getTokenFromHeader = <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.headers.authorization &amp;&amp; req.headers.authorization.split(<span class="string">' '</span>)[<span class="number">0</span>] === <span class="string">'Bearer'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> req.headers.authorization.split(<span class="string">' '</span>)[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> jwt(&#123;</span><br><span class="line">  secret: <span class="string">'MySuP3R_z3kr3t'</span>, <span class="comment">// å¿…é¡»å’Œä¸Šä¸€èŠ‚çš„ä»£ç çš„ signature ä¸€æ ·</span></span><br><span class="line"></span><br><span class="line">  userProperty: <span class="string">'token'</span>, <span class="comment">// this is where the next middleware can find the encoded data generated in services/auth:generateToken -&gt; 'req.token'</span></span><br><span class="line"></span><br><span class="line">  getToken: getTokenFromHeader, <span class="comment">// ä» request ä¸­è·å–åˆ° auth token çš„æ–¹æ³•</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªèƒ½ä»æ•°æ®åº“ä¸­è·å–åˆ°å®Œæ•´ç”¨æˆ·è®°å½•çš„ä¸­é—´ä»¶ï¼Œå¹¶ä¸”å°†è¿™äº›ç”¨æˆ·ä¿¡æ¯æ”¾è¿› request ä¸­ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (req, res, next) =&gt; &#123;</span><br><span class="line"> <span class="keyword">const</span> decodedTokenData = req.tokenData;</span><br><span class="line"> <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.findOne(&#123; <span class="attr">_id</span>: decodedTokenData._id &#125;)</span><br><span class="line"></span><br><span class="line"> req.currentUser = userRecord;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(!userRecord) &#123;</span><br><span class="line">   <span class="keyword">return</span> res.status(<span class="number">401</span>).end(<span class="string">'User not found'</span>)</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> next();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å°±å¯ä»¥è·³è½¬åˆ°ç”¨æˆ·è¯·æ±‚çš„è·¯ç”±äº†</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> isAuth <span class="keyword">from</span> <span class="string">'../middlewares/isAuth'</span>;</span><br><span class="line"><span class="keyword">import</span> attachCurrentUser <span class="keyword">from</span> <span class="string">'../middlewares/attachCurrentUser'</span>;</span><br><span class="line"><span class="keyword">import</span> ItemsModel <span class="keyword">from</span> <span class="string">'../models/items'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app) =&gt; &#123;</span><br><span class="line">  app.get(<span class="string">'/inventory/personal-items'</span>, isAuth, attachCurrentUser, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = req.currentUser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userItems = <span class="keyword">await</span> ItemsModel.find(&#123; <span class="attr">owner</span>: user._id &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(userItems).status(<span class="number">200</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ä¸¤ä¸ªä¸­é—´ä»¶è®¿é—®åˆ°çš„ inventory/personal-items è·¯ç”±å°±æ˜¯å®‰å…¨çš„ã€‚ä½ éœ€è¦æœ‰æ•ˆçš„ JWT æ‰èƒ½è®¿é—®è¿™ä¸ªè·¯ç”±ï¼Œå½“ç„¶å–½ï¼Œè·¯ç”±ä¹Ÿéœ€è¦ JWT ä¸­çš„ç”¨æˆ·ä¿¡æ¯æ‰èƒ½å»æ•°æ®åº“ä¸­æ­£ç¡®æŸ¥æ‰¾ç›¸åº”çš„ä¿¡æ¯ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆ-JWT-æ˜¯å®‰å…¨çš„"><a href="#ä¸ºä»€ä¹ˆ-JWT-æ˜¯å®‰å…¨çš„" class="headerlink" title="ä¸ºä»€ä¹ˆ JWT æ˜¯å®‰å…¨çš„ ?"></a>ä¸ºä»€ä¹ˆ JWT æ˜¯å®‰å…¨çš„ ?</h2><p>ä½ è¯»åˆ°è¿™é‡Œï¼Œé€šå¸¸ä¼šæƒ³åˆ°è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼š</p>
<p>Qï¼šå¦‚æœå¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸­è§£ç  JWT æ•°æ®çš„è¯ï¼Œåˆ«äººèƒ½å¦ä¿®æ”¹å…¶ä¸­ç”¨æˆ· id æˆ–è€…å…¶å®ƒçš„æ•°æ®å‘¢ï¼Ÿ</p>
<p>Aï¼šè™½ç„¶ä½ å¯ä»¥è½»æ˜“åœ°è§£ç  JWTï¼Œä½†æ˜¯æ²¡æœ‰ JWT ç”Ÿæˆæ—¶çš„å¯†é’¥ï¼ˆSecretï¼‰å°±æ— æ³•å¯¹ä¿®æ”¹åçš„æ–°æ•°æ®è¿›è¡Œç¼–ç ã€‚</p>
<p>ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œåƒä¸‡ä¸è¦æ³„æ¼å¯†é’¥ï¼ˆsecretï¼‰ã€‚</p>
<p>æˆ‘ä»¬çš„æœåŠ¡ç«¯ä¼šåœ¨ <code>IsAuth</code> è¿™ä¸ªä½¿ç”¨äº† <code>express-jwt</code> åº“çš„ä¸­é—´ä»¶ä¸­æ ¡éªŒå¯†é’¥ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æ˜ç™½äº† JWT æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å»çœ‹ä¸€ä¸ªå¾ˆé…·çš„åŠŸèƒ½ã€‚</p>
<h2 id="å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·-ğŸ•µï¸"><a href="#å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·-ğŸ•µï¸" class="headerlink" title="å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ· ğŸ•µï¸"></a>å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ· ğŸ•µï¸</h2><p>ç”¨æˆ·æ¨¡æ‹Ÿæ˜¯ä¸€ç§å¯ä»¥åœ¨æ— éœ€ç”¨æˆ·å¯†ç çš„æƒ…å†µä¸‹ï¼Œä»¥ä¸€ä¸ªç‰¹å®šç”¨æˆ·çš„èº«ä»½ç™»å½•çš„æŠ€æœ¯ã€‚</p>
<p>å¯¹äºè¶…çº§ç®¡ç†å‘˜ï¼ˆsuper adminsï¼‰æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿå¸®ä»–è§£å†³æˆ–è°ƒè¯•ä¸€ä¸ªä»…ä¼šè¯å¯è§çš„ç”¨æˆ·çš„é—®é¢˜ã€‚</p>
<p>æ²¡æœ‰å¿…è¦å»çŸ¥é“ç”¨æˆ·çš„å¯†ç ï¼Œåªéœ€è¦ä»¥æ­£ç¡®çš„å¯†é’¥å’Œå¿…è¦çš„ç”¨æˆ·ä¿¡æ¯æ¥åˆ›å»ºä¸€ä¸ª JWT å°±å¯ä»¥äº†ã€‚</p>
<p>æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªè·¯å¾„ï¼Œæ¥ç”Ÿæˆæ¨¡æ‹Ÿç”Ÿæˆç‰¹å®šç”¨æˆ·ç™»å½•çš„ JWTã€‚è¿™ä¸ªè·¯å¾„åªèƒ½è¢«è¶…çº§ç®¡ç†å‘˜è´¦æˆ·ä½¿ç”¨ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¶…çº§ç®¡ç†å‘˜åˆ›å»ºä¸€ä¸ªæ›´é«˜ç­‰çº§çš„è§’è‰²ï¼Œæ–¹æ³•æœ‰å¾ˆå¤šï¼Œæ¯”è¾ƒç®€å•çš„ä¸€ç§å°±æ˜¯ç›´æ¥å»æ•°æ®åº“ä¸­ç»™ç”¨æˆ·è®°å½•æ·»åŠ ä¸€ä¸ªâ€œroleâ€å­—æ®µã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/27/16f478aaae779e66?w=977&amp;h=166&amp;f=jpeg&amp;s=28234" alt> </p>
<p>ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸­é—´ä»¶æ¥æ£€æŸ¥ç”¨æˆ·è§’è‰²ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (requiredRole) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.currentUser.role === requiredRole) &#123;</span><br><span class="line">      <span class="keyword">return</span> next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">401</span>).send(<span class="string">'Action not allowed'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¸­é—´ä»¶éœ€è¦æ”¾åœ¨ <code>isAuth</code> å’Œ <code>attachCurrentUser</code> ä¹‹åã€‚</p>
<p>æœ€åï¼Œè¿™ä¸ªè·¯å¾„å°†ä¼šç”Ÿæˆä¸€ä¸ªèƒ½å¤Ÿæ¨¡æ‹Ÿç”¨æˆ·çš„ JWT ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> isAuth <span class="keyword">from</span> <span class="string">'../middlewares/isAuth'</span>;</span><br><span class="line"><span class="keyword">import</span> attachCurrentUser <span class="keyword">from</span> <span class="string">'../middlewares/attachCurrentUser'</span>;</span><br><span class="line"><span class="keyword">import</span> roleRequired <span class="keyword">from</span> <span class="string">'../middlwares/roleRequired'</span>;</span><br><span class="line"><span class="keyword">import</span> UserModel <span class="keyword">from</span> <span class="string">'../models/user'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app) =&gt; &#123;</span><br><span class="line">  app.post(<span class="string">'/auth/signin-as-user'</span>, isAuth, attachCurrentUser, roleRequired(<span class="string">'super-admin'</span>), (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userEmail = req.body.email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> UserModel.findOne(&#123; <span class="attr">email</span>: userEmail &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!userRecord) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">404</span>).send(<span class="string">'User not found'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">      user: &#123;</span><br><span class="line">        email: userRecord.email,</span><br><span class="line">        name: userRecord.name</span><br><span class="line">      &#125;,</span><br><span class="line">      jwt: <span class="keyword">this</span>.generateToken(userRecord)</span><br><span class="line">    &#125;)</span><br><span class="line">    .status(<span class="number">200</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆé»‘é­”æ³•ï¼Œè¶…çº§ç®¡ç†å‘˜åªéœ€è¦çŸ¥é“éœ€è¦è¢«æ¨¡æ‹Ÿçš„ç”¨æˆ·çš„Emailï¼ˆå¹¶ä¸”è¿™é‡Œçš„é€»è¾‘ä¸ç™»å½•ååˆ†ç›¸ä¼¼ï¼Œåªæ˜¯æ— éœ€æ£€æŸ¥å£ä»¤çš„æ­£ç¡®æ€§ï¼‰å°±å¯ä»¥æ¨¡æ‹Ÿè¿™ä¸ªç”¨æˆ·äº†ã€‚</p>
<p>å½“ç„¶ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºä¸éœ€è¦å¯†ç ï¼Œè¿™ä¸ªè·¯å¾„çš„å®‰å…¨æ€§å°±å¾—é  roleRequired ä¸­é—´ä»¶æ¥ä¿è¯äº†ã€‚</p>
<h1 id="ç»“è®º-ğŸ—ï¸"><a href="#ç»“è®º-ğŸ—ï¸" class="headerlink" title="ç»“è®º ğŸ—ï¸"></a>ç»“è®º ğŸ—ï¸</h1><p>è™½ç„¶ä¾èµ–ç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡å’Œåº“å¾ˆæ–¹ä¾¿ï¼ŒèŠ‚çº¦äº†å¼€å‘æ—¶é—´ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿéœ€è¦äº†è§£è®¤è¯èƒŒåçš„åº•å±‚é€»è¾‘å’ŒåŸç†ã€‚</p>
<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æ¢è®¨äº† JWT çš„åŠŸèƒ½ï¼Œä¸ºä»€ä¹ˆé€‰æ‹©ä¸€ä¸ªå¥½çš„åŠ å¯†ç®—æ³•éå¸¸é‡è¦ï¼Œä»¥åŠå¦‚ä½•å»æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ passport.js è¿™æ ·çš„åº“ï¼Œå°±å¾ˆéš¾åšåˆ°è¿™äº›äº‹ã€‚</p>
<p>åœ¨æœ¬ç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨é€šè¿‡ä½¿ç”¨ OAuth2 åè®®å’Œæ›´ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚ Firebase ç­‰ç¬¬ä¸‰æ–¹ç”¨äºèº«ä»½éªŒè¯çš„åº“ï¼‰æ¥ä¸ºå®¢æˆ·æä¾›â€œç¤¾äº¤ç™»å½•â€èº«ä»½éªŒè¯çš„ä¸åŒæ–¹æ³•ã€‚</p>
<h3 id="è¿™é‡Œæ˜¯ç¤ºä¾‹ä»“åº“-ğŸ”¬"><a href="#è¿™é‡Œæ˜¯ç¤ºä¾‹ä»“åº“-ğŸ”¬" class="headerlink" title="è¿™é‡Œæ˜¯ç¤ºä¾‹ä»“åº“ ğŸ”¬"></a><a href="https://github.com/santiq/nodejs-auth" target="_blank" rel="noopener">è¿™é‡Œæ˜¯ç¤ºä¾‹ä»“åº“ ğŸ”¬</a></h3><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul>
<li><a href="https://security.stackexchange.com/questions/193351/in-2018-what-is-the-recommended-hash-to-store-passwords-bcrypt-scrypt-argon2" target="_blank" rel="noopener">What is the recommended hash to store passwords: bcrypt, scrypt, Argon2?</a></li>
<li><a href="https://en.wikipedia.org/wiki/Timing_attack" target="_blank" rel="noopener">Timing attack</a></li>
</ul>
<blockquote>
<p>å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° <a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">æ˜é‡‘ç¿»è¯‘è®¡åˆ’</a> å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ <strong>æœ¬æ–‡æ°¸ä¹…é“¾æ¥</strong> å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚</p>
</blockquote>
<hr>
<blockquote>
<p><a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">æ˜é‡‘ç¿»è¯‘è®¡åˆ’</a> æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º <a href="https://juejin.im" target="_blank" rel="noopener">æ˜é‡‘</a> ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– <a href="https://github.com/xitu/gold-miner#android" target="_blank" rel="noopener">Android</a>ã€<a href="https://github.com/xitu/gold-miner#ios" target="_blank" rel="noopener">iOS</a>ã€<a href="https://github.com/xitu/gold-miner#å‰ç«¯" target="_blank" rel="noopener">å‰ç«¯</a>ã€<a href="https://github.com/xitu/gold-miner#åç«¯" target="_blank" rel="noopener">åç«¯</a>ã€<a href="https://github.com/xitu/gold-miner#åŒºå—é“¾" target="_blank" rel="noopener">åŒºå—é“¾</a>ã€<a href="https://github.com/xitu/gold-miner#äº§å“" target="_blank" rel="noopener">äº§å“</a>ã€<a href="https://github.com/xitu/gold-miner#è®¾è®¡" target="_blank" rel="noopener">è®¾è®¡</a>ã€<a href="https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½" target="_blank" rel="noopener">äººå·¥æ™ºèƒ½</a>ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ <a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">æ˜é‡‘ç¿»è¯‘è®¡åˆ’</a>ã€<a href="http://weibo.com/juejinfanyi" target="_blank" rel="noopener">å®˜æ–¹å¾®åš</a>ã€<a href="https://zhuanlan.zhihu.com/juejinfanyi" target="_blank" rel="noopener">çŸ¥ä¹ä¸“æ </a>ã€‚</p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2019/10/22/æ ¡å¯¹-å¦‚ä½•è®¾è®¡ä¸€æ¬¾è®¨äººå–œæ¬¢çš„æš—è‰²ä¸»é¢˜/" rel="prev" title="æ ¡å¯¹-å¦‚ä½•è®¾è®¡ä¸€æ¬¾è®¨äººå–œæ¬¢çš„æš—è‰²ä¸»é¢˜">
      <i class="fa fa-chevron-left"></i> æ ¡å¯¹-å¦‚ä½•è®¾è®¡ä¸€æ¬¾è®¨äººå–œæ¬¢çš„æš—è‰²ä¸»é¢˜
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2020/02/01/å…³äºè¿™å‡ ä¸ªæœˆ/" rel="next" title="å…³äºè¿™å‡ ä¸ªæœˆ">
      å…³äºè¿™å‡ ä¸ªæœˆ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ç®€ä»‹"><span class="nav-text">ç®€ä»‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å‰ç½®çŸ¥è¯†-âœï¸"><span class="nav-text">å‰ç½®çŸ¥è¯† âœï¸</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å†™ä¸€ä¸ªæ³¨å†Œç¨‹åº-ğŸ¥‡"><span class="nav-text">å†™ä¸€ä¸ªæ³¨å†Œç¨‹åº ğŸ¥‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å†æ¥å†™ä¸€ä¸ªç™»å½•ç¨‹åº-ğŸ¥ˆ"><span class="nav-text">å†æ¥å†™ä¸€ä¸ªç™»å½•ç¨‹åº ğŸ¥ˆ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ä½†æ˜¯ï¼ŒJWTåˆ°åº•æ˜¯å•¥ï¼Ÿ-ğŸ‘©â€ğŸ«"><span class="nav-text">ä½†æ˜¯ï¼ŒJWTåˆ°åº•æ˜¯å•¥ï¼Ÿ ğŸ‘©â€ğŸ«</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#node-js-ä¸­å¦‚ä½•åˆ›å»º-JWTï¼Ÿ-ğŸ­"><span class="nav-text">node.js ä¸­å¦‚ä½•åˆ›å»º JWTï¼Ÿ ğŸ­</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¿æŠ¤ç«¯ç‚¹ä»¥åŠéªŒè¯-JWT-âš”ï¸"><span class="nav-text">ä¿æŠ¤ç«¯ç‚¹ä»¥åŠéªŒè¯ JWT âš”ï¸</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸ºä»€ä¹ˆ-JWT-æ˜¯å®‰å…¨çš„"><span class="nav-text">ä¸ºä»€ä¹ˆ JWT æ˜¯å®‰å…¨çš„ ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·-ğŸ•µï¸"><span class="nav-text">å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ· ğŸ•µï¸</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç»“è®º-ğŸ—ï¸"><span class="nav-text">ç»“è®º ğŸ—ï¸</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è¿™é‡Œæ˜¯ç¤ºä¾‹ä»“åº“-ğŸ”¬"><span class="nav-text">è¿™é‡Œæ˜¯ç¤ºä¾‹ä»“åº“ ğŸ”¬</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‚è€ƒèµ„æ–™"><span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Hytonightäº‘æ¯</p>
  <div class="site-description" itemprop="description">äº‘ä¹‹æ¯ï¼Œæµ´ä¹æ²‚ï¼Œé£ä¹èˆé›©ï¼Œå’è€Œå½’</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/HytonightYX" title="GitHub â†’ https://github.com/HytonightYX" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:whosiyuan@qq.com" title="E-Mail â†’ mailto:whosiyuan@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div><a href="http://www.beian.miit.gov.cn">æµ™ICPå¤‡19011570å·-2</a></div>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hytonightäº‘æ¯</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme â€“ <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>
<script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script>
<script src="/blog/js/schemes/muse.js"></script>
<script src="/blog/js/next-boot.js"></script>



  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'poBG3RLh2xdaKYTvOB9yLgTP-gzGzoHsz',
      appKey     : 'uKHvvpz0NYgD3n5uxJKWUdVE',
      placeholder: "Lorem Ipsum...",
      avatar     : 'mp',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
